# 新增服务开发指南

## 1. 服务设计与Proto定义

### 1.1 设计服务接口
- 确定服务职责和边界
- 设计清晰的API接口
- 定义请求和响应数据结构

### 1.2 创建Proto文件
在 `backend/proto/` 目录下创建新的proto文件，如 `newservice.proto`：

```protobuf
syntax = "proto3";

package newservice;

option go_package = "./pb/newservice";

service Newservice {
  rpc Method1(Method1Request) returns (Method1Response);
  rpc Method2(Method2Request) returns (Method2Response);
}

message Method1Request {
  string param1 = 1;
  int32 param2 = 2;
}

message Method1Response {
  bool success = 1;
  string message = 2;
}

message Method2Request {
  string id = 1;
}

message Method2Response {
  string result = 1;
}
```

## 2. 生成服务代码

### 2.1 修改生成脚本
编辑 `backend/proto/generate_rpc.sh`，添加新服务的生成命令：

```bash
#!/bin/bash
set -e

# 当前目录
CUR_DIR=$(pwd)

# 生成主服务代码
echo "Generating main service code..."
goctl rpc protoc super.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=../rpc

# 生成Auth服务代码
echo "Generating Auth service code..."
goctl rpc protoc authservice.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=../rpc

# 生成新服务代码
echo "Generating Newservice code..."
goctl rpc protoc newservice.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=../rpc
```

### 2.2 执行生成脚本
```bash
cd /Users/admin/Documents/SuperAI_WebProject/backend/proto
sh generate_rpc.sh
```

## 3. 服务实现

### 3.1 实现服务逻辑
在 `backend/rpc/internal/logic/` 目录下创建新的逻辑文件，如 `method1logic.go`：

```go
package logic

import (
    "context"
    "newservice/pb/newservice"

    "github.com/zeromicro/go-zero/core/logx"
)

type Method1Logic struct {
    ctx context.Context
    logx.Logger
}

func NewMethod1Logic(ctx context.Context, l logx.Logger) *Method1Logic {
    return &Method1Logic{
        ctx:    ctx,
        Logger: l,
    }
}

func (l *Method1Logic) Method1(in *newservice.Method1Request) (*newservice.Method1Response, error) {
    // 实现业务逻辑
    return &newservice.Method1Response{
        Success: true,
        Message: "Success",
    }, nil
}
```

### 3.2 注册服务路由
在 `backend/rpc/internal/server/superserver.go` 中注册新服务：

```go
package server

import (
    "newservice/pb/newservice"
    "newservice/rpc/internal/logic"
    "newservice/rpc/internal/svc"

    "github.com/zeromicro/go-zero/zrpc"
    "google.golang.org/grpc"
)

func NewSuperServer(ctx *svc.ServiceContext) *zrpc.RpcServer {
    s := zrpc.MustNewServer(ctx.Config.RpcServerConf, func(grpcServer *grpc.Server) {
        // 注册现有服务
        super.RegisterSuperServer(grpcServer, &SuperServer{ctx: ctx})
        auth.RegisterAuthServer(grpcServer, &AuthServer{ctx: ctx})
        
        // 注册新服务
        newservice.RegisterNewserviceServer(grpcServer, &NewserviceServer{ctx: ctx})
    })
    return s
}

// 实现新服务的Server接口
type NewserviceServer struct {
    ctx *svc.ServiceContext
    newservice.UnimplementedNewserviceServer
}

func (s *NewserviceServer) Method1(ctx context.Context, in *newservice.Method1Request) (*newservice.Method1Response, error) {
    l := logic.NewMethod1Logic(ctx, s.ctx.Logger)
    return l.Method1(in)
}
```

## 4. 配置管理

### 4.1 服务配置
在 `backend/rpc/etc/super.yaml` 中添加新服务的配置：

```yaml
# 主服务配置
Name: super.rpc
ListenOn: 0.0.0.0:8080

# Etcd配置
Etcd:
  Hosts:
  - 127.0.0.1:2379
  Key: super.rpc

# 新服务配置
NewserviceRpc:
  Etcd:
    Hosts:
    - 127.0.0.1:2379
    Key: newservice.rpc
```

### 4.2 配置结构体定义
在 `backend/rpc/internal/config/config.go` 中添加新服务的配置结构体：

```go
package config

import "github.com/zeromicro/go-zero/zrpc"

type Config struct {
    zrpc.RpcServerConf
    // 现有服务配置
    AuthRpc zrpc.RpcClientConf
    // 新服务配置
    NewserviceRpc zrpc.RpcClientConf
}
```

## 5. 服务注册与发现

### 5.1 初始化服务上下文
在 `backend/rpc/internal/svc/servicecontext.go` 中初始化新服务客户端：

```go
package svc

import (
    "newservice/pb/newservice"
    "newservice/rpc/internal/config"

    "github.com/zeromicro/go-zero/core/logx"
    "github.com/zeromicro/go-zero/zrpc"
)

type ServiceContext struct {
    Config         config.Config
    // 现有客户端
    AuthClient     auth.AuthClient
    // 新服务客户端
    NewserviceClient newservice.NewserviceClient
}

func NewServiceContext(c config.Config) *ServiceContext {
    logx.Infof("ServiceContext init, config: %+v", c)
    
    // 初始化现有客户端
    var authClient auth.AuthClient
    if len(c.AuthRpc.Endpoints) > 0 || len(c.AuthRpc.Etcd.Hosts) > 0 {
        authConn := zrpc.MustNewClient(c.AuthRpc)
        authClient = auth.NewAuthClient(authConn.Conn())
    }
    
    // 初始化新服务客户端
    var newserviceClient newservice.NewserviceClient
    if len(c.NewserviceRpc.Endpoints) > 0 || len(c.NewserviceRpc.Etcd.Hosts) > 0 {
        newserviceConn := zrpc.MustNewClient(c.NewserviceRpc)
        newserviceClient = newservice.NewNewserviceClient(newserviceConn.Conn())
    }
    
    return &ServiceContext{
        Config:         c,
        AuthClient:     authClient,
        NewserviceClient: newserviceClient,
    }
}
```

## 6. 调用其他服务

### 6.1 在逻辑中调用新服务
在业务逻辑中使用服务客户端调用其他服务：

```go
package logic

import (
    "context"
    "newservice/pb/newservice"

    "github.com/zeromicro/go-zero/core/logx"
)

type SomeLogic struct {
    ctx context.Context
    logx.Logger
    newserviceClient newservice.NewserviceClient
}

func NewSomeLogic(ctx context.Context, l logx.Logger, newserviceClient newservice.NewserviceClient) *SomeLogic {
    return &SomeLogic{
        ctx:              ctx,
        Logger:           l,
        newserviceClient: newserviceClient,
    }
}

func (l *SomeLogic) SomeMethod() error {
    // 调用新服务
    resp, err := l.newserviceClient.Method1(l.ctx, &newservice.Method1Request{
        Param1: "test",
        Param2: 123,
    })
    if err != nil {
        return err
    }
    
    // 处理响应
    if resp.Success {
        l.Info("Method1 call success: ", resp.Message)
    }
    
    return nil
}
```

## 7. 测试与验证

### 7.1 启动Etcd服务
确保Etcd服务正在运行：

```bash
etcd
```

### 7.2 启动服务
启动主服务和新服务：

```bash
# 启动主服务
cd /Users/admin/Documents/SuperAI_WebProject/backend/rpc
go run super.go

# 在新终端启动新服务
cd /Users/admin/Documents/Newservice/backend/rpc
go run newservice.go
```

### 7.3 验证服务注册
使用Etcd客户端查看服务注册情况：

```bash
etcdctl get --prefix /super.rpc
etcdctl get --prefix /newservice.rpc
```

### 7.4 测试服务调用
编写测试代码或使用gRPC客户端工具测试服务调用：

```go
// 示例测试代码
package main

import (
    "context"
    "fmt"
    "newservice/pb/newservice"

    "github.com/zeromicro/go-zero/zrpc"
)

func main() {
    // 连接新服务
    conn := zrpc.MustNewClient(zrpc.RpcClientConf{
        Etcd: zrpc.EtcdConf{
            Hosts: []string{"127.0.0.1:2379"},
            Key:   "newservice.rpc",
        },
    })
    defer conn.Close()
    
    // 创建客户端
    client := newservice.NewNewserviceClient(conn.Conn())
    
    // 调用服务
    resp, err := client.Method1(context.Background(), &newservice.Method1Request{
        Param1: "test",
        Param2: 123,
    })
    if err != nil {
        fmt.Printf("调用失败: %v\n", err)
        return
    }
    
    fmt.Printf("调用成功: %+v\n", resp)
}
```

## 8. 最佳实践

### 8.1 服务设计原则
- 单一职责：每个服务只负责一个核心业务领域
- 接口清晰：API设计简洁明了，避免过度复杂
- 版本控制：考虑未来接口演进，预留扩展空间

### 8.2 配置管理
- 集中管理：所有服务配置统一使用Etcd服务发现
- 环境隔离：区分开发、测试、生产环境配置
- 动态更新：支持配置热更新

### 8.3 服务调用
- 错误处理：妥善处理调用失败和超时情况
- 重试机制：对幂等操作实现合理的重试策略
- 监控告警：监控服务调用成功率和延迟

### 8.4 测试与部署
- 单元测试：覆盖核心业务逻辑
- 集成测试：验证服务间调用
- 持续集成：自动化构建、测试和部署

## 9. 常见问题

### 9.1 服务注册失败
- 检查Etcd服务是否正常运行
- 验证Etcd配置是否正确
- 检查服务监听地址是否可达

### 9.2 服务调用超时
- 检查网络连接是否正常
- 验证服务是否正常启动
- 调整客户端超时配置

### 9.3 配置不生效
- 检查配置文件路径是否正确
- 验证配置结构体与配置文件字段是否匹配
- 查看日志输出，确认配置加载情况

## 10. 总结

按照以上步骤，您可以成功新增和集成一个新的gRPC服务到现有系统中。关键要点包括：

1. 正确定义和生成proto代码
2. 实现服务逻辑和注册路由
3. 配置服务发现和客户端初始化
4. 测试服务注册和调用
5. 遵循服务设计最佳实践

通过这种方式，可以保持系统的模块化和可扩展性，便于后续添加更多服务。